<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>D3: Global Net Imports/Exports of the largest 3 traders</title>
    <script type="text/javascript" src="http://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
 
    <style type="text/css">
        .label {
            font-weight: bold;
            text-anchor: middle;
            cursor: default;
        }
    </style>
</head>
<body>
    <script type="text/javascript">


        //Width and height
        var w = 1000;
        var h = 500;
        active = d3.select(null);

        //Color for the choropleth
        var color = d3.scaleQuantize()
            .range(["rgb(237,248,233)", "rgb(186,228,179)",
                "rgb(116,196,118)", "rgb(49,163,84)", "rgb(0,109,44)"]);

        //Define map projection
        var projection = d3.geoMercator()
            .translate([w / 2, h / 2]);

        //Define path generator
        var path = d3.geoPath()
            .projection(projection);

        //Create SVG element
        var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        var formatAsPercent = d3.format(",.1%");

        var labels = [
            {
                x: 100,
                y: 100,
                text: 'Test Label 1',
                orient: 'right'
            },
            {
                x: 200,
                y: 200,
                text: 'Test Label 2',
                orient: 'right'
            }
        ]


            d3.csv("Global_Imp_Exp_Volumes.csv", function (data) {

                //Set input domain for color scale
                color.domain([
                    d3.min(data, function (d) { return d.value; }),
                    d3.max(data, function (d) { return d.value; })
                ]);

                //Load in GeoJSON data
                d3.json("world_countries.json", function (json) {

                    //Merge the ag. data and GeoJSON
                    //Loop through once for each ag. data value
                    for (var i = 0; i < data.length; i++) {

                        //Grab state name
                        var dataCountry = data[i].country;

                        //Grab data value, and convert from string to float
                        var dataValue = parseFloat(data[i].value);

                        //Find the corresponding state inside the GeoJSON
                        for (var j = 0; j < json.features.length; j++) {

                            var jsonCountry = json.features[j].properties.name;
                            if (dataCountry == jsonCountry) {

                                //Copy the data value into the JSON
                                json.features[j].properties.value = dataValue;

                                //Stop looking through the JSON
                                break;

                            }
                        }
                    }

                    //Bind data and create one path per GeoJSON feature
                    svg.selectAll("path")
                        .data(json.features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .style("fill", function (d) {
                            //Get data value
                            var value = d.properties.value;

                            if (value) {
                                //If value exists…
                                return color(value);
                            } else {
                                //If value is undefined…
                                return "#ccc";
                            }
                        });

                    //svg.selectAll("text")
                    //    .data(json.features)
                    //    .enter()
                    //    .append("text")
                    //    .attr("class", "label")
                    //    .attr("transform", function (d) { return "translate(" + path.centroid(d) + ")"; })
                    //    .text(function (d) {
                    //        if (d.properties.value) {
                    //            return formatAsPercent(d.properties.value);
                    //        }
                    //    });
                        //.attr("x", function (d) {                        
                        //    return path.centroid(d)[0];
                        //})
                        //.attr("y", function (d) {
                        //    return path.centroid(d)[1];
                        //})
                        //.text(function (d) {
                        //    if (d.properties.value) {
                        //        return formatAsPercent(d.properties.value);
                        //    };
                        //});

                    svg.selectAll("text")
                        .data(labels)
                        .enter()
                        .append("text")
                        .attr("class", "label")
                        .attr("x", function (d) { return d.x })
                        .attr("y", function (d) { return d.y })
                        .text(function (d) {
                            return d.text;
                        });
                    //    });

                });

            });


    </script>
</body>
</html>